#include <WiFi.h>
#include "DHT.h"

// ===== WIFI =====
const char* ssid = "YOUR_WIFI";
const char* password = "YOUR_PASSWORD";

// ===== PIN =====
#define SOIL_PIN   34
#define RELAY_PIN  26
#define DHT_PIN    27

#define DHTTYPE DHT22
DHT dht(DHT_PIN, DHTTYPE);

// ===== THAM SỐ =====
int soilThreshold = 2000;     // Ngưỡng độ ẩm đất
bool autoMode = true;        // true: tự động, false: thủ công

void setup() {
  Serial.begin(115200);

  pinMode(RELAY_PIN, OUTPUT);
  digitalWrite(RELAY_PIN, HIGH); // Tắt bơm

  dht.begin();

  // Kết nối WiFi
  WiFi.begin(ssid, password);
  Serial.print("Connecting WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi Connected");
}

void loop() {
  // ===== ĐỌC CẢM BIẾN =====
  int soilValue = analogRead(SOIL_PIN);
  float humidity = dht.readHumidity();
  float temperature = dht.readTemperature();

  // Kiểm tra lỗi
  if (isnan(humidity) || isnan(temperature)) {
    Serial.println("Failed to read DHT sensor!");
    return;
  }

  // ===== HIỂN THỊ =====
  Serial.println("----- SENSOR DATA -----");
  Serial.print("Soil moisture: ");
  Serial.println(soilValue);
  Serial.print("Air humidity: ");
  Serial.print(humidity);
  Serial.println(" %");
  Serial.print("Temperature: ");
  Serial.print(temperature);
  Serial.println(" *C");

  // ===== TƯỚI NƯỚC =====
  if (autoMode) {
    if (soilValue > soilThreshold) {
      pumpOn();
    } else {
      pumpOff();
    }
  }

  delay(5000);
}

// ===== HÀM ĐIỀU KHIỂN =====
void pumpOn() {
  digitalWrite(RELAY_PIN, LOW);
  Serial.println("Pump ON");
}

void pumpOff() {
  digitalWrite(RELAY_PIN, HIGH);
  Serial.println("Pump OFF");
}
